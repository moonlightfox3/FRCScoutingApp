<!doctype html>
<title>Select Year</title>
<link rel="icon" href="./icons/icon.svg">
<link rel="apple-touch-icon" sizes="1024x1024" href="./icons/apple-touch-icon-1024x1024.png">
<link rel="manifest" href="./manifest.json">
<link rel="stylesheet" href="./libs/style.css">
<link rel="stylesheet" href="./libs/index-style.css">
<script src="./libs/elements.js"></script>

<div id="yearsEl"></div>
<div id="updateDateEl">Loading...</div>

<script src="./libs/swrun.js"></script>
<script src="./libs/profile.js"></script>
<script src="./libs/gamepads.js"></script>
<script src="./libs/gamepadControl.js"></script>
<script src="./libs/install.js"></script>
<script src="./libs/datafile.js"></script>
<script src="./year-libs/keys.js"></script>
<script>
    checkImportedFile() // There should not be any files imported here
    createProfileMenus()

    // Show the update status element
    let commitId = null
    let commitDate = null
    let deployedToPages = null
    function showCommitUpdate () {
        if (commitId != null) updateDateEl.innerText = `Commit ${commitId} (${commitDate})${deployedToPages ? "" : " - Updated content available soon"}`
        else updateDateEl.innerText = "Failed to check GitHub. App may be loaded from your browser's offline cache"
    }
    onSwReady = async function () {
        console.debug("Getting GitHub data...")
        
        let sw = getSw()
        if (sw == null) showCommitUpdate()
        else sw.postMessage({id: "reload"})
    }
    addEventListener("message", function (ev) {
        let msg = ev.data
        console.debug(`Got message: ${msg?.id ?? "null"}`)
        if (msg?.id == "github") {
            commitId = msg.commitId
            commitDate = msg.commitDate
            deployedToPages = msg.deployedToPages
            showCommitUpdate()
        } else console.debug("Unknown message")
    })
    
    const years = {
        2025: "Reefscape",
        2026: "Rebuilt",
    }
    const pitYears = {
        2026: "Rebuilt",
    }
    const tools = {
        "server": "Server Authentication",
        "storageViewer": "Browser Storage Viewer",
        "contentManager": "Content Manager",
    }
    const unreleasedYears = []
    const unavailableYears = []
    const noImgYears = []
    const unavailableTools = []

    // Create button elements automatically
    function displayBreak (isLarge) {
        let br = document.createElement("div")
        br.className = "break"
        if (isLarge) br.classList.add("large")
        yearsEl.append(br)
    }
    function displayYears (years, isPit) {
        yearsEl.append(`${isPit ? "Pit" : "Match"} scouting:`)
        displayBreak(false)

        for (let i = 0; i < Object.keys(years).length; i++) {
            let year = Object.keys(years)[i]
            let name = years[year]

            let a = document.createElement("a")
            a.className = "year-link"
            a.href = `./year${isPit ? "-pit" : ""}/${name}.html`
            let button = document.createElement("button")
            button.className = "year"
            button.id = `${year}`
            button.innerText = `${name} (${year})`
            if (currentYear == +year) button.classList.add("current")
            if (unreleasedYears.includes(+year)) button.classList.add("unreleased")
            button.disabled = unavailableYears.includes(+year)

            if (!noImgYears.includes(+year)) {
                let img = document.createElement("img")
                img.className = "year-img"
                img.src = `./year-img/${name}.png`
                button.append(img)
            }
            
            a.append(button)
            yearsEl.append(a)
        }
        displayBreak(true)
    }
    function displayTools (tools) {
        yearsEl.append("Tools:")
        displayBreak(false)

        for (let i = 0; i < Object.keys(tools).length; i++) {
            let tool = Object.keys(tools)[i]
            let name = tools[tool]

            let a = document.createElement("a")
            a.className = "tool-link"
            a.href = `./tool/${tool}.html`
            let button = document.createElement("button")
            button.className = "tool"
            button.innerText = name
            button.disabled = unavailableTools.includes(tool)

            a.append(button)
            yearsEl.append(a)
        }
    }
    displayYears(years, false)
    displayYears(pitYears, true)
    displayTools(tools)
    displayBreak(true)
    displayBreak(true)
    displayBreak(true)

    // Setup
    gamepadElCursorInit(
        true,
        document.querySelectorAll("button.year"),
        el => el.style.color = "gray",
        el => el.style.color = "black",
        el => el.click(),
    )
    displayInstallButton()
</script>
