<!doctype html>
<title>Browser Storage Viewer</title>
<link rel="icon" href="../icons/icon.svg">
<link rel="apple-touch-icon" sizes="1024x1024" href="../icons/apple-touch-icon-1024x1024.png">
<link rel="manifest" href="../manifest.json">
<link rel="stylesheet" href="../libs/style.css">
<link rel="stylesheet" href="./storageViewer-style.css">
<script src="../libs/elements.js"></script>

<a href="../index.html"><button id="backBtn">Back</button></a> | <button id="refreshBtn">Refresh</button> | <button id="clearBtn">Clear</button>
<hr>
<div id="displayEl">
    <ul id="matchesEl">
    </ul>
    <ul id="pitsEl">
    </ul>
</div>

<script src="../libs/swrun.js"></script>
<script src="../libs/gamepads.js"></script>
<script src="../libs/gamepadControl.js"></script>
<script src="../libs/install.js"></script>
<script>
    function displayStorage () {
        matchesEl.innerHTML = ""
        pitsEl.innerHTML = ""

        let storage = localStorage.getItem("FRCScoutingApp_files")
        if (storage == null) return
        storage = JSON.parse(storage)

        let newMatchStorage = displayStoragePart(storage.matches ?? {}, matchesEl)
        if (newMatchStorage != undefined) storage.matches = newMatchStorage
        let newPitStorage = displayStoragePart(storage.pits ?? {}, pitsEl)
        if (newPitStorage != undefined) storage.pits = newPitStorage

        storage = JSON.stringify(storage)
        localStorage.setItem("FRCScoutingApp_files", storage)
    }
    function displayStoragePart (storage, el) {
        for (let year of Object.keys(storage)) {
            for (let match of storage[year]) {
                let li = document.createElement("li")
                li.innerText = match.name
                li.onclick = function () {
                    let action = prompt("What do you want to do with this file?\n1. Download\n2. Delete")
                    if (action == "1") {
                        // Download file with an <a> element
                        let a = document.createElement("a")
                        a.download = match.name
                        a.href = `data:text/plain;base64,${btoa(match.data)}`
                        a.click()
                    } else if (action == "2") {
                        if (!confirm("Are you sure you want to delete this file?")) return

                        delete storage[year][match]
                        alert("File deleted.")
                        displayStorage()
                        return storage
                    } else alert("Invalid input.")
                }

                el.append(li)
            }
        }
    }
    displayStorage()
    refreshBtn.onclick = () => displayStorage()

    clearBtn.onclick = function () {
        if (!confirm("Are you sure you want to clear your browser's storage?\nThis will delete all saved files!")) return
        localStorage.removeItem("FRCScoutingApp_files")
        displayStorage()
    }
</script>
