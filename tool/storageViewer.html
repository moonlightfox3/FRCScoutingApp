<!doctype html>
<title>Browser Storage Viewer</title>
<link rel="icon" href="../icons/icon.svg">
<link rel="apple-touch-icon" sizes="1024x1024" href="../icons/apple-touch-icon-1024x1024.png">
<link rel="manifest" href="../manifest.json">
<link rel="stylesheet" href="../libs/style.css">
<link rel="stylesheet" href="./storageViewer-style.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="./libs/server.js"></script>

<a href="../index.html"><button id="backBtn">Back</button></a> | <button id="refreshBtn">Refresh</button> | <button id="clearBtn">Clear</button> | <button id="uploadBtn">Upload</button> | Browser Storage Viewer
<hr>
<div id="displayEl">
    <ul id="matchesEl">
    </ul>
    <ul id="pitsEl">
    </ul>
</div>

<script src="../libs/swrun.js"></script>
<script src="../libs/install.js"></script>
<script>
    function displayStorage () {
        matchesEl.innerHTML = ""
        pitsEl.innerHTML = ""

        let storage = localStorage.getItem("FRCScoutingApp_files")
        if (storage == null) return
        storage = JSON.parse(storage)

        displayStoragePart(storage, "matches", matchesEl)
        displayStoragePart(storage, "pits", pitsEl)
    }
    function displayStoragePart (storage, part, el) {
        let storagePart = storage[part]
        if (storagePart == undefined) return

        for (let year of Object.keys(storagePart)) {
            for (let i = 0; i < storagePart[year].length; i++) {
                let match = storagePart[year][i]
                let li = document.createElement("li")
                li.innerText = `${match.name} (${match.data.length} bytes)`
                li.onclick = function () {
                    let action = prompt("What do you want to do with this file?\n1. Download\n2. Delete")
                    if (action == "1") {
                        // Download file with an <a> element
                        let a = document.createElement("a")
                        a.download = match.name
                        a.href = `data:text/plain;base64,${btoa(match.data)}`
                        a.click()
                    } else if (action == "2") {
                        if (!confirm("Are you sure you want to delete this file?")) return

                        storage[part][year].splice(i, 1)
                        let storageStr = JSON.stringify(storage)
                        localStorage.setItem("FRCScoutingApp_files", storageStr)
                        
                        displayStorage()
                    } else if (action == "" || action == null) return
                    else alert("Invalid input.")
                }

                el.append(li)
            }
        }
    }
    displayStorage()
    refreshBtn.onclick = () => displayStorage()

    clearBtn.onclick = function () {
        if (!confirm("Are you sure you want to clear your browser's storage?\nThis will delete all saved files!")) return
        localStorage.removeItem("FRCScoutingApp_files")
        displayStorage()
    }

    function getStorage () {
        let files = []
        let storage = localStorage.getItem("FRCScoutingApp_files")

        files.push(...getStoragePart(storage, "matches", false))
        files.push(...getStoragePart(storage, "pits", true))
        return files
    }
    function getStoragePart (storage, part, partIsPit) {
        let storagePart = storage[part]
        if (storagePart == undefined) return []

        let files = []
        for (let year of Object.keys(storagePart)) {
            let val = storagePart[year]
            files.push({name: val.name, data: val.data, is_pit: partIsPit, year: +year})
        }
        return files
    }
    uploadBtn.onclick = async function () {
        let files = getStorage()
        if (files.length == 0) return alert("There are no files to upload!")
        
        let isSignedIn = await isSignedInToSupabase()
        if (!isSignedIn) return alert("Please sign into the server to upload files!")
        
        let events = await getEventListSupabase()
        if (events.length == 0) return alert("There are currently no events available to upload files to.")
        events = events.toSorted((a, b) => b.is_current - a.is_current).toSorted((a, b) => a.is_testing - b.is_testing)

        let eventsStr = events.map((val, idx) => `${idx}: ${val.name}${val.is_current ? " (current)" : ""}${val.is_testing ? " (testing/practice)" : ""}`).join("\n")
        let event = prompt(`Which event would you like to upload files to?\n${eventsStr}`)
        if (event == "" || event == null || isNaN(event) || +event < 0 || +event >= events.length) return alert("Invalid event choice.")
        event = events[event]

        let success = await addEventDatasSupabase(event, files)
        if (success) {
            alert("Files uploaded to the server!")
            if (confirm("Delete locally saved files?")) {
                localStorage.removeItem("FRCScoutingApp_files")
                displayStorage()
            }
        } else alert("Failed to upload data to the server.")
    }
</script>
