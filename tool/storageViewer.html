<!doctype html>
<title>Browser Storage Viewer</title>
<link rel="icon" href="../icons/icon.svg">
<link rel="apple-touch-icon" sizes="1024x1024" href="../icons/apple-touch-icon-1024x1024.png">
<link rel="manifest" href="../manifest.json">
<link rel="stylesheet" href="../libs/style.css">
<link rel="stylesheet" href="./storageViewer-style.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="../libs/server.js"></script>

<a href="../index.html"><button id="backBtn">Back</button></a> | <button id="refreshBtn">Refresh</button><button id="clearBtn">Clear</button><button id="uploadBtn">Upload all</button> | Browser Storage Viewer
<hr>
<button id="openOneBtn" disabled>Open file</button><button id="downloadOneBtn" disabled>Download file</button><button id="deleteOneBtn" disabled>Delete file</button>
<hr>
<div id="displayEl">
    Match files:
    <ul id="matchesEl">
    </ul>
    Pit files:
    <ul id="pitsEl">
    </ul>
</div>

<script src="../libs/swrun.js"></script>
<script src="../libs/install.js"></script>
<script src="../libs/datafile.js"></script>
<script>
    let selectedLi = null
    function displayStorage () {
        deselectLi()
        liDataList = []
        matchesEl.innerHTML = ""
        pitsEl.innerHTML = ""

        let storage = localStorage.getItem("FRCScoutingApp_files")
        if (storage == null) return
        storage = JSON.parse(storage)

        displayStoragePart(storage, "matches", matchesEl)
        displayStoragePart(storage, "pits", pitsEl)
    }
    let liDataList = []
    function displayStoragePart (storage, part, el) {
        let storagePart = storage[part]
        if (storagePart == undefined) return

        for (let year of Object.keys(storagePart)) {
            for (let i = 0; i < storagePart[year].length; i++) {
                let match = storagePart[year][i]
                let li = document.createElement("li")
                li.innerText = `${match.name} (${year} - ${match.data.length} bytes)`

                li.dataset.index = liDataList.push({match, storage, part, year, i}) - 1
                li.onclick = function () {
                    if (selectedLi == null) {
                        openOneBtn.disabled = false
                        downloadOneBtn.disabled = false
                        deleteOneBtn.disabled = false
                    } else selectedLi.style.listStyleType = "circle"
                    this.style.listStyleType = "disc"
                    selectedLi = this
                }

                el.append(li)
            }
        }
    }
    displayStorage()
    refreshBtn.onclick = () => displayStorage()

    clearBtn.onclick = function () {
        if (!confirm("Are you sure you want to clear your browser's storage?\nThis will delete all saved files!")) return
        clearFileStorage()
        displayStorage()
    }
    uploadBtn.onclick = async function () {
        let success = await userUploadStorageToServer()
        if (success) displayStorage()
    }

    function deselectLi () {
        if (selectedLi != null) {
            selectedLi.style.listStyleType = "circle"
            selectedLi = null
            
            openOneBtn.disabled = true
            downloadOneBtn.disabled = true
            deleteOneBtn.disabled = true
        }
    }
    openOneBtn.onclick = function () {
        let {match, storage, part, year, i} = liDataList[+selectedLi.dataset.index]

        getImportedFile(match.data)
    }
    downloadOneBtn.onclick = function () {
        let {match, storage, part, year, i} = liDataList[+selectedLi.dataset.index]

        let a = document.createElement("a")
        a.download = match.name
        a.href = `data:text/plain;base64,${btoa(match.data)}`
        a.click()
    }
    deleteOneBtn.onclick = function () {
        if (!confirm("Are you sure you want to delete this file?")) return
        let {match, storage, part, year, i} = liDataList[+selectedLi.dataset.index]

        storage[part][year].splice(i, 1)
        let storageStr = JSON.stringify(storage)
        localStorage.setItem("FRCScoutingApp_files", storageStr)
        
        displayStorage()
    }
</script>
